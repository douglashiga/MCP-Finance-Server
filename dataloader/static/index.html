<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Finance Data Loader</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --border: #334155;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        aside {
            background-color: var(--card-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
        }

        main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Nav */
        h1 {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        nav button:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        nav button.active {
            background-color: var(--accent);
            color: white;
        }

        /* Components */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .grid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-item h3 {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-item .value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 500;
        }

        tr:hover td {
            background-color: rgba(255, 255, 255, 0.02);
        }

        /* Status Badges */
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .bg-success {
            background-color: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .bg-danger {
            background-color: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .bg-running {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        /* Buttons */
        .btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background-color: var(--accent-hover);
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
        }

        /* Logs */
        pre.log-output {
            background: #000;
            color: #ccc;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            max-height: 400px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: white;
            font-family: inherit;
        }

        input:focus {
            outline: 2px solid var(--accent);
            border-color: transparent;
        }

        /* Icons */
        .icon {
            width: 1.25em;
            height: 1.25em;
            vertical-align: text-bottom;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <aside>
            <h1>‚ö°Ô∏è Data Loader</h1>
            <nav id="nav-menu">
                <button data-view="dashboard" class="active">Dashboard</button>
                <button data-view="jobs">Jobs</button>
                <button data-view="schema">Schema</button>
                <button data-view="data">Data Browser</button>
                <button data-view="logs">Logs</button>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem; font-size: 0.75rem; color: var(--text-secondary);">
                MCP Finance Project<br>
                v1.0.0
            </div>
        </aside>

        <main id="content">
            <!-- Content injected via JS -->
        </main>
    </div>

    <!-- Scripts -->
    <script>
        const API_BASE = '/api';

        // SVG Icons
        const ICONS = {
            play: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            refresh: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>',
            trash: '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>',
        };

        // State
        let currentView = 'dashboard';

        // Router
        document.querySelectorAll('nav button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                render();
            });
        });

        async function fetchData(endpoint) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`);
                if (!res.ok) throw new Error(res.statusText);
                return await res.json();
            } catch (err) {
                console.error(err);
                return null;
            }
        }

        async function postData(endpoint, body) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return await res.json();
            } catch (err) {
                alert('Failed: ' + err.message);
            }
        }

        window.runHealthCheck = async () => {
            const data = await fetchData('/jobs');
            const job = data.jobs.find(j => j.name === 'Pipeline Health Check');
            if (!job) {
                alert('Pipeline Health Check job not found. Please run seed script.');
                return;
            }
            if (!confirm('Run full pipeline health check now? (Checks all loaders)')) return;

            const btn = document.getElementById('health-check-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `${ICONS.refresh} Running...`;
            }

            await postData(`/jobs/${job.id}/run`, {});

            setTimeout(() => {
                render();
                alert('Health check triggered! Check logs for results.');
            }, 1000);
        };

        function renderStatus(status) {
            const cls = status === 'success' ? 'bg-success' :
                status === 'failed' ? 'bg-danger' :
                    status === 'running' ? 'bg-running' : 'bg-secondary';
            return `<span class="badge ${cls}">${status}</span>`;
        }

        // Views
        const Views = {
            async dashboard() {
                const stats = await fetchData('/stats');
                if (!stats) return '<p>Error loading stats</p>';

                return `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2>Dashboard</h2>
                    <button id="health-check-btn" class="btn" onclick="runHealthCheck()">${ICONS.refresh} Run Health Check</button>
                </div>
                <div class="grid-stats">
                    <div class="card stat-item">
                        <h3>Total Jobs</h3>
                        <div class="value">${stats.jobs.total}</div>
                    </div>
                    <div class="card stat-item">
                        <h3>Active Jobs</h3>
                        <div class="value" style="color:var(--success)">${stats.jobs.active}</div>
                    </div>
                    <div class="card stat-item">
                        <h3>Total Runs</h3>
                        <div class="value">${stats.runs.total}</div>
                    </div>
                    <div class="card stat-item">
                        <h3>Stocks Loaded</h3>
                        <div class="value" style="color:var(--accent)">${stats.data.stocks}</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Recent Failures</h3>
                    ${stats.recent_failures.length === 0 ? '<p style="color:var(--text-secondary)">No recent failures (Clean run!)</p>' : `
                    <table>
                        <thead><tr><th>Job</th><th>Time</th><th>Error</th></tr></thead>
                        <tbody>
                            ${stats.recent_failures.map(f => `
                                <tr>
                                    <td>${f.job_name}</td>
                                    <td>${new Date(f.started_at).toLocaleString()}</td>
                                    <td style="color:var(--danger); font-family:monospace">${f.stderr}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    `}
                </div>

                <div class="card">
                    <h3>Next Scheduled Runs</h3>
                    <table>
                        <thead><tr><th>Job</th><th>Next Run</th></tr></thead>
                        <tbody>
                            ${stats.next_runs.map(r => `
                                <tr>
                                    <td>${r.name}</td>
                                    <td>${r.next_run ? new Date(r.next_run).toLocaleString() : 'Not Scheduled'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            },

            async jobs() {
                const data = await fetchData('/jobs');
                if (!data) return '<p>Error loading jobs</p>';

                window.triggerJob = async (id) => {
                    if (!confirm('Run this job immediately?')) return;
                    await postData(`/jobs/${id}/run`, {});
                    render(); // refresh
                };

                window.viewTable = (tableName) => {
                    window.selectedTable = tableName;
                    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-view="data"]').classList.add('active');
                    currentView = 'data';
                    render();
                };

                return `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2>Jobs Management</h2>
                    <button class="btn" onclick="alert('Use API to add distinct jobs for now!')">+ New Job</button>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Schedule (Cron)</th>
                                <th>Affected Tables</th>
                                <th>Last Run</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.jobs.map(job => `
                                <tr>
                                    <td>#${job.id}</td>
                                    <td>
                                        <strong>${job.name}</strong><br>
                                        <small style="color:var(--text-secondary)">${job.script_path}</small>
                                    </td>
                                    <td><code>${job.cron_expression || 'Manual'}</code></td>
                                    <td>
                                        ${job.affected_tables ? job.affected_tables.split(',').map(t =>
                    `<span class="badge" style="background:var(--accent); cursor:pointer; margin-right:0.25rem;" onclick="viewTable('${t.trim()}')" title="Click to view table">${t.trim()}</span>`
                ).join('') : '<span style="color:var(--text-secondary)">-</span>'}
                                    </td>
                                    <td>
                                        ${job.last_run ? `
                                            <div>${renderStatus(job.last_run.status)}</div>
                                            <small>${new Date(job.last_run.started_at).toLocaleString()}</small>
                                        ` : 'Never'}
                                    </td>
                                    <td>${job.is_active ? '<span style="color:var(--success)">Active</span>' : '<span style="color:var(--text-secondary)">Paused</span>'}</td>
                                    <td>
                                        <button class="btn btn-sm" onclick="triggerJob(${job.id})">${ICONS.play} Run</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            },

            async schema() {
                const data = await fetchData('/schema');
                if (!data) return '<p>Error</p>';

                return `
                <h2>Database Schema</h2>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                ${data.tables.map(table => `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                            <h3 style="margin:0; color:var(--accent)">${table.name}</h3>
                            <span class="badge" style="background:#334155">${table.row_count} rows</span>
                        </div>
                        <div style="max-height:200px; overflow-y:auto;">
                            <table style="font-size:0.75rem">
                                <tbody>
                                    ${table.columns.map(col => `
                                        <tr>
                                            <td style="padding:0.25rem 0.5rem">
                                                ${col.primary_key ? 'üîë ' : ''}
                                                <strong>${col.name}</strong>
                                            </td>
                                            <td style="padding:0.25rem 0.5rem; color:var(--text-secondary)">${col.type}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('')}
                </div>
            `;
            },

            async data() {
                const schema = await fetchData('/schema');
                const tables = schema.tables.map(t => t.name);

                // Get selected table from URL or default
                const urlParams = new URLSearchParams(window.location.search);
                const selectedTable = window.selectedTable || tables[0];

                const tableData = await fetchData(`/tables/${selectedTable}?per_page=20`);

                window.switchTable = (tbl) => {
                    window.selectedTable = tbl;
                    render();
                };

                return `
                <h2>Data Browser</h2>
                <div class="card" style="padding:1rem; display:flex; gap:1rem; align-items:center;">
                    <label style="margin:0">Select Table:</label>
                    <select onchange="switchTable(this.value)" style="width:200px">
                        ${tables.map(t => `<option value="${t}" ${t === selectedTable ? 'selected' : ''}>${t}</option>`).join('')}
                    </select>
                </div>

                <div class="card" style="overflow-x:auto">
                    ${!tableData.data.length ? '<p>No data found.</p>' : `
                    <table>
                        <thead>
                            <tr>${tableData.columns.map(c => `<th>${c}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${tableData.data.map(row => `
                                <tr>${tableData.columns.map(col => `<td>${row[col] !== null ? row[col] : '<span style="color:#444">NULL</span>'}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                    `}
                </div>
            `;
            },

            async logs() {
                const data = await fetchData('/runs?limit=50');

                window.viewLog = async (runId) => {
                    const logData = await fetchData(`/runs/${runId}/log`);
                    const win = window.open("", "_blank", "width=800,height=600");
                    win.document.write(`<pre style="background:#111; color:#eee; padding:1rem;">${logData.stdout}\n\n=== STDERR ===\n${logData.stderr}</pre>`);
                };

                return `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2>Execution Logs</h2>
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <label style="margin:0; font-size:0.75rem">Filter:</label>
                        <select onchange="window.logFilter = this.value; render();" style="font-size:0.75rem; padding:0.25rem;">
                            <option value="all" ${!window.logFilter || window.logFilter === 'all' ? 'selected' : ''}>All Runs</option>
                            <option value="manual" ${window.logFilter === 'manual' ? 'selected' : ''}>Manual Runs</option>
                            <option value="cron" ${window.logFilter === 'cron' ? 'selected' : ''}>Scheduled Runs</option>
                            <option value="health_check" ${window.logFilter === 'health_check' ? 'selected' : ''}>Health Checks</option>
                        </select>
                    </div>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Job</th>
                                <th>Status</th>
                                <th>Trigger</th>
                                <th>Time</th>
                                <th>Duration</th>
                                <th>Records</th>
                                <th>Log</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.runs.filter(r => !window.logFilter || window.logFilter === 'all' || r.trigger === window.logFilter).map(run => `
                                <tr>
                                    <td>${run.job_name}</td>
                                    <td>${renderStatus(run.status)}</td>
                                    <td><span class="badge" style="background:#334155">${run.trigger}</span></td>
                                    <td>${new Date(run.started_at).toLocaleString()}</td>
                                    <td>${run.duration_seconds ? run.duration_seconds + 's' : '-'}</td>
                                    <td>${run.records_affected || '-'}</td>
                                    <td><button class="btn btn-sm" onclick="viewLog(${run.id})">View Log</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            }
        };

        // Main render loop
        async function render() {
            const content = document.getElementById('content');
            content.innerHTML = '<p style="color:var(--text-secondary)">Loading...</p>';
            try {
                content.innerHTML = await Views[currentView]();
            } catch (err) {
                content.innerHTML = `<p style="color:var(--danger)">Error rendering view: ${err.message}</p>`;
            }
        }

        // Initial load
        render();

        // Auto-refresh dashboard every 10s
        setInterval(() => {
            if (currentView === 'dashboard') render();
        }, 10000);

    </script>
</body>

</html>