services:

  # ============================================================
  # PostgreSQL — Shared database for all services
  # ============================================================
  postgres:
    image: postgres:16-alpine
    container_name: finance-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: finance_db
      POSTGRES_USER: finance
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-finance_secret}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U finance -d finance_db" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================================
  # IB Gateway (headless) — runs the Interactive Brokers Gateway
  # ============================================================
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: ib-gateway
    restart: unless-stopped
    environment:
      TWS_USERID: ${TWS_USERID:?Set TWS_USERID in .env}
      TWS_PASSWORD: ${TWS_PASSWORD:?Set TWS_PASSWORD in .env}
      TRADING_MODE: ${TRADING_MODE:-paper}
      TWS_SETTINGS_PATH: /home/ibgateway/Jts
      READ_ONLY_API: "no"
      TWS_ACCEPT_INCOMING: accept
      VNC_SERVER_PASSWORD: password
    ports:
      - "4001:${IB_GATEWAY_PORT:-4004}" # API port (paper=4004, live=4003) exposed as 4001 on host
      - "5901:5900" # VNC for debugging
    volumes:
      - ib-gateway-settings:/home/ibgateway/Jts
    healthcheck:
      test: [ "CMD", "nc", "-z", "127.0.0.1", "${IB_GATEWAY_PORT:-4004}" ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================
  # MCP Finance Server — 22 tools for LLM agents
  # ============================================================
  mcp-finance:
    build: .
    container_name: mcp-finance
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      ib-gateway:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql://finance:${POSTGRES_PASSWORD:-finance_secret}@postgres:5432/finance_db
      - IB_HOST=ib-gateway
      - IB_PORT=${IB_GATEWAY_PORT:-4004}
      - IB_CLIENT_ID=1
      - MCP_TRANSPORT=sse
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      - IB_ENABLED=${IB_ENABLED:-true}
      - LOG_LEVEL=INFO
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8000:8000"
    volumes:
      - ./logs:/app/logs

  # ============================================================
  # Data Loader — Scheduler + API + Web UI (port 8001)
  # ============================================================
  dataloader:
    build: .
    container_name: dataloader
    command: python -m dataloader.app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://finance:${POSTGRES_PASSWORD:-finance_secret}@postgres:5432/finance_db
      - LOG_LEVEL=INFO
      - IB_HOST=ib-gateway
      - IB_PORT=${IB_GATEWAY_PORT:-4004}
      - IB_CLIENT_ID=2 # Separate client ID to avoid conflict with mcp-server (ID 1)
      - IB_ENABLED=${IB_ENABLED:-true}
      - DATALOADER_ALLOW_INSECURE=${DATALOADER_ALLOW_INSECURE:-true}
      - DATALOADER_API_KEY=${DATALOADER_API_KEY:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "8001:8001"
    volumes:
      - ./logs:/app/logs

  # ============================================================
  # Seed — One-shot init (run manually: docker compose run seed)
  # ============================================================
  seed:
    build: .
    container_name: finance-seed
    command: python -m dataloader.seed
    depends_on:
      postgres:
        condition: service_healthy
      ib-gateway:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql://finance:${POSTGRES_PASSWORD:-finance_secret}@postgres:5432/finance_db
      - IB_HOST=ib-gateway
      - IB_PORT=${IB_GATEWAY_PORT:-4004}
      - IB_CLIENT_ID=3
      - IB_ENABLED=${IB_ENABLED:-true}
      - LOG_LEVEL=INFO
    profiles:
      - init # Only runs with: docker compose --profile init run seed

volumes:
  postgres-data:
  ib-gateway-settings:
